# Boswell Production Docker Compose
#
# Usage:
#   1. Copy .env.example to .env and fill in your API keys
#   2. Run: docker compose -f docker-compose.prod.yml up -d
#   3. Access at http://your-domain:8000

services:
  db:
    image: postgres:15-alpine
    container_name: boswell-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-boswell}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      POSTGRES_DB: ${POSTGRES_DB:-boswell}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-boswell}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: boswell-web
    command: ["./scripts/start_web.sh"]
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-boswell}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-boswell}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:?Set CLAUDE_API_KEY in .env}
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY:?Set DEEPGRAM_API_KEY in .env}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:?Set ELEVENLABS_API_KEY in .env}
      DAILY_API_KEY: ${DAILY_API_KEY:?Set DAILY_API_KEY in .env}
      SECRET_KEY: ${SECRET_KEY:?Set SECRET_KEY in .env}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?Set ADMIN_PASSWORD in .env}
      BASE_URL: ${BASE_URL:-http://localhost:8000}
    ports:
      - "${PORT:-8000}:8000"
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: boswell-worker
    command: ["./scripts/start_worker.sh"]
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-boswell}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-boswell}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}
      DAILY_API_KEY: ${DAILY_API_KEY}
    depends_on:
      db:
        condition: service_healthy
      web:
        condition: service_started
    restart: unless-stopped

volumes:
  postgres-data:
    name: boswell-postgres-data
